**Clustering and distribution profiling of COG-L category genes**  

FigS2a was generated using Excel by counting genes assigned to each COG category, based on eggNOG annotation file at Zenodo, including "OM-RGC_emapper_COG.xls.gz", "TSGC_emapper_COG.xls.gz", and "DSGC_emapper_COG.xls.gz".

We clustered all COG-L genes (see DS.TS.OM.all.COG_L.pep.gz at Zenodo, the sequences from TSGC were renamed based on TSGC.geneid.change.list.gz, see below) in DSGC, OM-RGC, and TSGC using MMseqs2:  

`mmseqs easy-cluster DS.TS.OM.all.COG_L.pep COG_L_DS.TS.OM ./linclust_tmp --threads 20 --cov-mode 0 --cluster-mode 0 -c 0.5 --min-seq-id 0.2`  

and the clustering relationship was deposited at Zenodo (Fig2.COG_L_DS.TS.OM_cluster.row.gz). Data for Fig. 2a were calculated with the script Fig2a.stat.sh.   

All genes annotated as COG-L category from DSGC, OM-RGC, and TSGC were taxonomically annotated using MMseqs2 easy-taxonomy with GTDB (r226) with --tax-lineage 1:  

`mmseqs easy-taxonomy DS.TS.OM.all.COG_L.pep /path_to_database/GTDB COG-L.pep.txt tmp --tax-lineage 1`  

and we calculated data for Fig. S2b with the scripts FigS2b.stat.sh based on the taxonomic annotation result Fig2.COG_L.mmseqsGTDB.lca.tsv.gz at Zenodo. To avoid issues caused by special characters in gene IDs, we have updated the ID for the TSGC gene; details are provided in the file TSGC.geneid.change.list.gz, which has been deposited at Zenodo.  

To calculate the proportion of COG-L genes in microbial MAGs generated from both deep-sea and upper-ocean metagenomes, we used Prodigal (v2.6.3) and eggNOG-mapper (v2.1.12) to annotate the high quality MAGs:  

```bash
prodigal -i MAG_ID.genome.fa -a MAG_ID.faa -d MAG_ID.ffn -f gff -o MAG_ID.gff
export EGGNOG_DATA_DIR=/Path_to_database/eggNOG
emapper.py -i MAG_ID.faa -o MAG_ID
awk -F"\t" '{sum+=1;if($7~/L/){cogl+=1}}END{rate=cogl/sum;print rate,cogl,sum}' MAG_ID_emapper.anno.tsv > MAG_ID_COG-L_proportion.tsv
```

Then we merged all the MAG_ID_COG-L_proportion.tsv and the results of GTDBtk annotation and CheckM, see FigS2c.MAG_COG-L_stat.txt, and all MAGs in this table can be found in Deepsea_HQ_MAGs_drep.tar.gz at Zenodo. Fig. S2c was generated using FigS2c.boxplot.R. In addition to compare all MAGs generated from datasets of DSGC and Tara Ocean (TOBG), we also compared the phyla with more than 20 high-quality MAGs from either DSGC or TOBG (used the same data of OM-RGC) datasets based on the FigS2c.HQ-MAGs_by_phylum.txt.  

To quantify the abundance of all deep-sea COG-L genes, we followed the methods used in the GMGC study, where gene abundance was estimated as the number of short reads mapping to a given sequence. In brief, minimap2 (v2.28-r1209) was employed to align reads to these genes with default parameters, and the relative abundance of each gene was computed with the “dist1” option of NGLess (v1.5.0) to distribute multiple mappers (short reads mapping to > 1 unigenes) by unique mapper abundance. The results were normalized by library size to get relative abundance, and the abundance of each gene cluster was determined by summing up the relative abundances of genes in that cluster (see scirpts Fig2b.abundance_calculate.sh and deep-sea_map_single.ngl, and result Fig2.COG_L_PC_abundance.matrix.gz at Zenodo).

The detection number and average abundances shown in Fig. 2b were calculated with the scirpt Fig2b.detection_abundance_stat.pl and the resulted file was Fig2b.cluster_dtc_adb.stat.tsv.gz, and Fig. 2b was generated using script Fig2b.2d_density.R.  

After filtering excl-DS-clusters with detection > 100, we got 105,558 clusters:  

`awk '$3>100 && $NF~/Uniq/' Fig2b.cluster_dtc_adb.stat.tsv | wc -l`  

We selected the COG term that covered most members in a cluster as the annotation of the cluster, and among the 728,098 COG-L category gene clusters, 92.23% showed functional consistency within each cluster, with most of the clustered genes (≥ 90%) were assigned to the same COGs (see script Fig2.COG_annotation_by_PC.sh, and results Fig2.COG_L_PC.memberCOG.stat.gz, Fig2.rep_COG_anno_by_PC.tsv.gz).   

COG enrichment in exclusively deep-sea cluster (excl-DS-clusters) was conducted using a two-tailed Fisher's exact test, where deep-sea gene counts in excl-DS-clusters were compared against the background gene counts in shared clusters (see script Fig2c.fisher.sh and Fig2c.fisher_test.R, and result files Fig2c.DS_COG-L.stat and Fig2c.DS_COG-L.fisher.tsv). The abundance matirxs of the all prevalent clusters and those with enriched COG terms were generated by:  

```bash
awk '$3>100 && $NF~/Uniq/' Fig2b.cluster_dtc_adb.stat.tsv > tmpfile_prevalent_excl-cluster.list
perl fishInWinter.pl tmpfile_prevalent_excl-cluster.list Fig2.COG_L_PC_abundance.matrix > FigS2d.PC_Matrix_All.tsv
perl fishInWinter.pl -bc 2 Fig2c.DS_COG-L.fisher.tsv Fig2.rep_COG_anno_by_PC.tsv |perl fishInWinter.pl tmpfile_prevalent_cluster.list - |perl fishInWinter.pl FigS2c.PC_Matrix_All.tsv > Fig2c.PC_Matrix_enriched.tsv
```

Seurat (v4.0.0) was used to cluster samples with the abundances of either all prevalent (detection > 100) gene clusters or only the prevalent clusters with enriched COG terms (see script Fig2c_S2d.seurat.R, and results files Fig2c.PC_Matrix_enriched_0.5_coor.txt and FigS2d.PC_Matrix_All_0.5_coor.txt). The association between deep-sea ecosystem types and gene distribution was calculated using the Cramer's V test with Fig2c.cramer test.R. The sankey plot was generated using FigS2e.sankey.R based on the clustering result of seurat (FigS2e.sankey.csv).  

Fig. 2de and the abundance fold-change (P-value) were generated using the script Fig2de.stat_boxplot_between_habitats.R with Fig2de.Cluster_Abd_significance.txt as input. Phylogenetic tree of Cas9 proteins was generated by:  

```bash
mafft --auto Fig2f.cas9.fa > Fig2f.cas9.mafft
iqtree3 -s Fig2f.cas9.mafft -m MFP #see file Fig2f.cas9.mafft.treefile
```

**Selection test for shared protein clusters among DSGC, OM-RGC, and TSGC**  

To investigate the evolution of deep-sea genes, we examined the presence of rapidly evolved genes using a branch-site model, adaptive branch-site random effects likelihood (aBSREL), and followed the methods in the GMGC study (DOI: 10.1038/s41586-021-04233-4) with some modifications. The clustering relationships of the clusters used in this analysis were based on the Fig2.5837clusters_for_hyphy.tsv.gz at Zenodo. All protein sequences are availible in DS.TS.OM.all.COG_L.pep.gz while the CDS sequences used in this analysis are availible in Fig2.all.unigen_for_hyphy.cds.gz (the sequences from TSGC were renamed based on TSGC.geneid.change.list.gz), and both files have been deposited at Zenodo. The pipeline for the 5,837 tested clusters shown in Fig. 2h was Fig2h.muscle2hyphy.sh, which also included the script to estimate the phylogenetic diversity shown in Fig. S2k. Additionally, we also tested the results in Fig. 2h with a slower but more accurate pipeline, where we employed mafft (L-INS-I) and IQ-Tree3 instead of muscle (super5) and FastTree, see FigS2l.mafft2hyphy.sh. For both pipelines, we provided example directories (Fig2h_S2l.HyPhy_example_output.zip) containing all intermediate files. The P-value of each tested gene was extracted from the JSON files (e.g., DSM_0100156101.cds.aln.ABSREL.json) generated by HyPhy using Fig2h.extract_pvalues.pl. The statistical data for Fig. 2h was calculated using Fig2h.stat_hyphy_json.pl, and the results were summarized in Fig2h.hyphy_stat.tsv and FigS2l.mafft_hyphy.tsv. Fig. 2h and Fig. S2l were generated using Fig2h.dotplot_boxplot.R and FigS2l.boxplot.R, respectively.

For the nucleotide diversity and pN/pS analysis, we first focused on genes in the HyPhy analysis (HyPhy_Genes) that could be assigned to MAGs (Relationship between HyPhy_Genes to MAGs was provided in FigS2mn.instrain_result.txt.gz, see blow). We selected samples where the number of HyPhy_Genes associated with MAGs exceeded 100. For each qualifying sample, reads were mapped against a dereplicated set of MAGs (derived from all 2038 samples) using Bowtie2 and SAMtools to generate BAM files. Finally, inStrain profile was run with the following command (e.g., for sampleA):  

```bash
bowtie2 -x drep_MAGs.fa -1 sampleA.clean.fq1.gz -2 sampleA.clean.fq2.gz |samtools view -Sb -o sampleA.MAG.bam -
inStrain profile sampleA.bam sampleA.allmag.fa -o sampleA.IS -p 5 --database_mode -g sampleA.ffn -s sampleA.stb
```

Here, drep_MAGs.fa is all dereplicated MAGs of the DSGC dataset (see Deepsea_HQ_MAGs_drep.tar.gz at Zenodo), sampleA.allmag.fa contains contig sequences of MAGs present in sampleA, sampleA.ffn includes CDS sequences of HyPhy_Genes associated with MAGs in sampleA, and sampleA.stb defines contig-to-MAG relationships. In total, 57,013 genes were tested by inStrain (see file FigS2mn.instrain_result.txt, where pN/pS and nucl_diversity values were extracted from inStrain output file: *.IS_gene_info.tsv), and inStrain successfully calculated the pN/pS value for 35,568 genes. The results of these 35,568 genes were used to generate Fig. S2mn with FigS2mn.boxplot.R.  

For the comparison of detection rates between rapidly evolved genes (marked as "REG") and the others (marked as "NS") in each gene cluster (clusters with less than 3 genes marked as "REG" or "NS" were omitted due to insurfficient number for wilcoxon test), we first calculated the detection rates of each HyPhy_Genes in DSGC (824,876 genes, see file Fig2i.DShyphy_gene.dtc.tsv.gz) based on the abundance matrix generated by NGLess (see methods of Fig. 2b). The Wilcoxon test was used to investigate if rapidly evolved genes are more prevalent (with higher frequencies of detection) in deep-sea than other genes in the same gene cluster, and a false discovery rate correction (P < 0.05) was implemented using the Benjamini-Hochberg procedure (see Fig2i.valcano.R). Fig. 2j was generated with Fig2j.source_data.txt.  

**PS: Files listed in "Files_at_Zenodo.txt" have been deposited at Zenodo with DOI: 10.5281/zenodo.17621312**  

